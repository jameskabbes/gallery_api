

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>arbor_imago.services.gallery &mdash; arbor_imago 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            arbor_imago
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">arbor_imago</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">arbor_imago</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../services.html">arbor_imago.services</a></li>
      <li class="breadcrumb-item active">arbor_imago.services.gallery</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for arbor_imago.services.gallery</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlmodel</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlmodel.ext.asyncio.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">datetime_module</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">arbor_imago</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">custom_types</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">core_utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">arbor_imago.models.tables</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gallery</span> <span class="k">as</span> <span class="n">GalleryTable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">arbor_imago.services.gallery_permission</span><span class="w"> </span><span class="kn">import</span> <span class="n">GalleryPermission</span> <span class="k">as</span> <span class="n">GalleryPermissionService</span><span class="p">,</span> <span class="n">base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">arbor_imago.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">gallery</span> <span class="k">as</span> <span class="n">gallery_schema</span>


<div class="viewcode-block" id="Gallery">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Gallery</span><span class="p">(</span>
        <span class="n">base</span><span class="o">.</span><span class="n">Service</span><span class="p">[</span>
            <span class="n">GalleryTable</span><span class="p">,</span>
            <span class="n">custom_types</span><span class="o">.</span><span class="n">Gallery</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminCreate</span><span class="p">,</span>
            <span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminUpdate</span><span class="p">,</span>
            <span class="nb">str</span>
        <span class="p">],</span>
        <span class="n">base</span><span class="o">.</span><span class="n">SimpleIdModelService</span><span class="p">[</span>
            <span class="n">GalleryTable</span><span class="p">,</span>
            <span class="n">custom_types</span><span class="o">.</span><span class="n">Gallery</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">],</span>
<span class="p">):</span>

    <span class="n">_MODEL</span> <span class="o">=</span> <span class="n">GalleryTable</span>

<div class="viewcode-block" id="Gallery.model_folder_name">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery.model_folder_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">model_folder_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inst</span><span class="p">:</span> <span class="n">GalleryTable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">custom_types</span><span class="o">.</span><span class="n">Gallery</span><span class="o">.</span><span class="n">folder_name</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">inst</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;root&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">user_id</span>
        <span class="k">elif</span> <span class="n">inst</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">inst</span><span class="o">.</span><span class="n">name</span></div>


<div class="viewcode-block" id="Gallery.get_date_and_name_from_folder_name">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery.get_date_and_name_from_folder_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_date_and_name_from_folder_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="n">custom_types</span><span class="o">.</span><span class="n">Gallery</span><span class="o">.</span><span class="n">folder_name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">custom_types</span><span class="o">.</span><span class="n">GalleryDateAndName</span><span class="p">:</span>

        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d</span><span class="si">{4}</span><span class="s1">-\d</span><span class="si">{2}</span><span class="s1">-\d</span><span class="si">{2}</span><span class="s1">) (.+)$&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">date_str</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime_module</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">custom_types</span><span class="o">.</span><span class="n">GalleryDateAndName</span><span class="p">(</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">custom_types</span><span class="o">.</span><span class="n">GalleryDateAndName</span><span class="p">(</span>
                <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">folder_name</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Gallery.is_available">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery.is_available">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">is_available</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">gallery_available_admin</span><span class="p">:</span> <span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminAvailable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="c1"># raise an exception if the parent gallery does not exist</span>
        <span class="k">if</span> <span class="n">gallery_available_admin</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fetch_by_id_with_exception</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">gallery_available_admin</span><span class="o">.</span><span class="n">parent_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">gallery_available_admin</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">gallery_available_admin</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="n">gallery_available_admin</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="n">gallery_available_admin</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
        <span class="p">)))</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_authorization_new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;authorized_user_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;create_model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">base</span><span class="o">.</span><span class="n">UnauthorizedError</span><span class="p">(</span>
                    <span class="s1">&#39;Unauthorized to post gallery for another user&#39;</span>
                <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_authorization_existing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;authorized_user_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;authorized_user_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">user_id</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">base</span><span class="o">.</span><span class="n">UnauthorizedError</span><span class="p">(</span>
                        <span class="s1">&#39;Unauthorized to </span><span class="si">{operation}</span><span class="s1"> this gallery&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]))</span>

                <span class="n">gallery_permission</span> <span class="o">=</span> <span class="k">await</span> <span class="n">GalleryPermissionService</span><span class="o">.</span><span class="n">fetch_by_id</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">],</span> <span class="n">custom_types</span><span class="o">.</span><span class="n">GalleryPermissionId</span><span class="p">(</span>
                        <span class="n">gallery_id</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="n">user_id</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;authorized_user_id&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># if the gallery is private and user has no access, pretend it doesn&#39;t exist</span>
                <span class="k">if</span> <span class="n">gallery_permission</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visibility_level</span> <span class="o">==</span> <span class="n">config</span><span class="o">.</span><span class="n">VISIBILITY_LEVEL_NAME_MAPPING</span><span class="p">[</span><span class="s1">&#39;private&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">base</span><span class="o">.</span><span class="n">NotFoundError</span><span class="p">(</span>
                        <span class="n">GalleryTable</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

                <span class="c1"># either public or user has access</span>

                <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;get&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gallery_permission</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">gallery_permission</span><span class="o">.</span><span class="n">permission_level</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">PERMISSION_LEVEL_NAME_MAPPING</span><span class="p">[</span><span class="s1">&#39;viewer&#39;</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="n">base</span><span class="o">.</span><span class="n">UnauthorizedError</span><span class="p">(</span>
                            <span class="s1">&#39;Unauthorized to </span><span class="si">{operation}</span><span class="s1"> this gallery&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]))</span>

                <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gallery_permission</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">gallery_permission</span><span class="o">.</span><span class="n">permission_level</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">PERMISSION_LEVEL_NAME_MAPPING</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="n">base</span><span class="o">.</span><span class="n">UnauthorizedError</span><span class="p">(</span>
                            <span class="s1">&#39;Unauthorized to </span><span class="si">{operation}</span><span class="s1"> this gallery&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]))</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_validation_post</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">],</span> <span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminAvailable</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;create_model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminAvailable</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_validation_patch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="c1"># take self, overwrite it with the update_model, and see if the combined model is available</span>
        <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">],</span> <span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminAvailable</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminAvailable</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;update_model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">gallery_schema</span><span class="o">.</span><span class="n">GalleryAdminAvailable</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">}))</span>

<div class="viewcode-block" id="Gallery.get_dir">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery.get_dir">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">gallery</span><span class="p">:</span> <span class="n">GalleryTable</span><span class="p">,</span>  <span class="n">root</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">gallery</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">root</span> <span class="o">/</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_folder_name</span><span class="p">(</span><span class="n">gallery</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_dir</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fetch_by_id_with_exception</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">gallery</span><span class="o">.</span><span class="n">parent_id</span><span class="p">),</span> <span class="n">root</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_folder_name</span><span class="p">(</span><span class="n">gallery</span><span class="p">)</span></div>


<div class="viewcode-block" id="Gallery.get_parents">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery.get_parents">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_parents</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">gallery</span><span class="p">:</span> <span class="n">GalleryTable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">GalleryTable</span><span class="p">]:</span>

        <span class="k">if</span> <span class="n">gallery</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_parents</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fetch_by_id_with_exception</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">gallery</span><span class="o">.</span><span class="n">parent_id</span><span class="p">)))</span>
            <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gallery</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parents</span></div>


<div class="viewcode-block" id="Gallery.get_root_gallery">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery.get_root_gallery">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_root_gallery</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">custom_types</span><span class="o">.</span><span class="n">Gallery</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GalleryTable</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)))</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span></div>


<div class="viewcode-block" id="Gallery.model_inst_from_create_model">
<a class="viewcode-back" href="../../../arbor_imago.services.html#arbor_imago.services.gallery.Gallery.model_inst_from_create_model">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">model_inst_from_create_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">create_model</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_MODEL</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">core_utils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="o">**</span> <span class="n">create_model</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="c1"># @classmethod</span>
    <span class="c1"># async def update(cls, params, custom_params={}):</span>
    <span class="c1">#     &quot;&quot;&quot;Used in conjunction with API endpoints, raises exceptions while trying to update an instance of the model by ID&quot;&quot;&quot;</span>

    <span class="c1">#     model_inst = await cls.fetch_by_id_with_exception(params[&#39;session&#39;], params[&#39;id&#39;])</span>

    <span class="c1">#     await cls._check_authorization_existing({</span>
    <span class="c1">#         &#39;session&#39;: params[&#39;session&#39;],</span>
    <span class="c1">#         &#39;c&#39;: params[&#39;c&#39;],</span>
    <span class="c1">#         &#39;model_inst&#39;: model_inst,</span>
    <span class="c1">#         &#39;operation&#39;: &#39;update&#39;,</span>
    <span class="c1">#         &#39;id&#39;: params[&#39;id&#39;],</span>
    <span class="c1">#         &#39;admin&#39;: params[&#39;admin&#39;],</span>
    <span class="c1">#         &#39;authorized_user_id&#39;: params[&#39;authorized_user_id&#39;]</span>
    <span class="c1">#     })</span>
    <span class="c1">#     await cls._check_validation_patch({**params, &#39;model_inst&#39;: model_inst})</span>

    <span class="c1">#     original_dir = await cls.get_dir(params[&#39;session&#39;], model_inst, params[&#39;c&#39;].galleries_dir)</span>

    <span class="c1">#     await cls._update_model_inst(model_inst, params[&#39;update_model&#39;])</span>

    <span class="c1">#     # await cls._after_update({</span>
    <span class="c1">#     #     **params, &#39;model_inst&#39;: model_inst}, custom_params)</span>

    <span class="c1">#     # by default, rename the folder if the name, date, or parent_id has changed</span>
    <span class="c1">#     if custom_params.get(&#39;rename_folder&#39;, True):</span>
    <span class="c1">#         if &#39;name&#39; in params[&#39;update_model&#39;].model_fields_set or &#39;date&#39; in params[&#39;update_model&#39;].model_fields_set or &#39;parent_id&#39; in params[&#39;update_model&#39;].model_fields_set:</span>
    <span class="c1">#             new_dir = (await cls.get_dir(params[&#39;session&#39;], model_inst, params[&#39;c&#39;].galleries_dir)).parent / cls.model_folder_name(model_inst)</span>
    <span class="c1">#             original_dir.rename(new_dir)</span>

    <span class="c1">#     await params[&#39;session&#39;].commit()</span>
    <span class="c1">#     await params[&#39;session&#39;].refresh(model_inst)</span>
    <span class="c1">#     return model_inst</span>

    <span class="c1"># @classmethod</span>
    <span class="c1"># async def _after_create(cls, params, custom_params={}):</span>

    <span class="c1">#     if custom_params.get(&#39;mkdir&#39;, False):</span>
    <span class="c1">#         (await cls.get_dir(params[&#39;session&#39;], params[&#39;model_inst&#39;], params[&#39;c&#39;].galleries_dir)).mkdir()</span>

    <span class="c1">#     return await super()._after_create(params, custom_params)</span>

    <span class="c1"># @classmethod</span>
    <span class="c1"># async def _after_delete(cls, params, custom_params={}):</span>

    <span class="c1">#     if custom_params.get(&#39;rmtree&#39;, False):</span>
    <span class="c1">#         shutil.rmtree((await cls.get_dir(params[&#39;session&#39;], params[&#39;model_inst&#39;], params[&#39;c&#39;].galleries_dir)))</span>

    <span class="c1"># async def sync_with_local(self, session: Session, c: client.Client, dir: pathlib.Path) -&gt; None:</span>

    <span class="c1">#     if not dir.exists():</span>
    <span class="c1">#         raise HTTPException(status.HTTP_404_NOT_FOUND,</span>
    <span class="c1">#                             detail=&#39;Directory not found&#39;)</span>

    <span class="c1">#     if self.folder_name != dir.name:</span>
    <span class="c1">#         raise HTTPException(status.HTTP_400_BAD_REQUEST,</span>
    <span class="c1">#                             detail=&#39;Folder name does not match gallery name&#39;)</span>

    <span class="c1">#     files: list[pathlib.Path] = []</span>
    <span class="c1">#     dirs: list[pathlib.Path] = []</span>
    <span class="c1">#     for item in dir.iterdir():</span>
    <span class="c1">#         if item.is_dir():</span>
    <span class="c1">#             dirs.append(item)</span>
    <span class="c1">#         if item.is_file():</span>
    <span class="c1">#             files.append(item)</span>

    <span class="c1">#     # Add new galleries, remove old ones</span>
    <span class="c1">#     local_galleries_by_folder_name = {</span>
    <span class="c1">#         item.name: item for item in dirs}</span>
    <span class="c1">#     db_galleries_by_folder_name = {</span>
    <span class="c1">#         gallery.folder_name: gallery for gallery in self.children}</span>

    <span class="c1">#     local_galleries_folder_names = set(</span>
    <span class="c1">#         local_galleries_by_folder_name.keys())</span>
    <span class="c1">#     db_galleries_folder_names = set(db_galleries_by_folder_name.keys())</span>

    <span class="c1">#     toadd = local_galleries_folder_names - db_galleries_folder_names</span>
    <span class="c1">#     to_remove = db_galleries_folder_names - local_galleries_folder_names</span>

    <span class="c1">#     for folder_name in to_remove:</span>
    <span class="c1">#         gallery = db_galleries_by_folder_name[folder_name]</span>
    <span class="c1">#         await Gallery.api_delete(session=session, c=c, id=gallery._id, authorized_user_id=self.user_id, admin=False, delete_method_kwargs=GalleryAdminApiDeleteParams(rmtree=False))</span>

    <span class="c1">#     for folder_name in toadd:</span>
    <span class="c1">#         date, name = self.get_date_and_name_from_folder_name(</span>
    <span class="c1">#             folder_name)</span>
    <span class="c1">#         new_gallery = await Gallery.api_post(</span>
    <span class="c1">#             session=session, c=c, authorized_user_id=self.user_id, admin=False, create_model=GalleryAdminCreate(name=name, user_id=self.user_id, visibility_level=self.visibility_level, parent_id=self.id, date=date),</span>
    <span class="c1">#             create_method_kwargs=GalleryAdminCreateParams(mkdir=False))</span>

    <span class="c1">#     # add new files, remove old ones</span>
    <span class="c1">#     local_file_by_names = {</span>
    <span class="c1">#         file.name: file for file in files}</span>
    <span class="c1">#     db_files_by_names = {</span>
    <span class="c1">#         file.name: file for file in self.files}</span>

    <span class="c1">#     local_file_names = set(local_file_by_names.keys())</span>
    <span class="c1">#     db_file_names = set(db_files_by_names.keys())</span>

    <span class="c1">#     toadd = local_file_names - db_file_names</span>
    <span class="c1">#     to_remove = db_file_names - local_file_names</span>

    <span class="c1">#     for file_name in to_remove:</span>
    <span class="c1">#         file = db_files_by_names[file_name]</span>

    <span class="c1">#         # if this is the last image tied to that version, delete the version too</span>
    <span class="c1">#         if file.suffix in ImageFileMetadataConfig._SUFFIXES:</span>
    <span class="c1">#             image_version = await ImageVersion.read(session, file.image_file_metadata.version_id)</span>
    <span class="c1">#             if len(image_version.image_file_metadatas) == 1:</span>
    <span class="c1">#                 await ImageVersion.api_delete(session=session, c=c, id=image_version.id, authorized_user_id=self.user_id, admin=False)</span>

    <span class="c1">#         await File.api_delete(session=session, c=c, id=file.id, authorized_user_id=self.user_id, admin=False, unlink=False)</span>

    <span class="c1">#     image_files: list[File] = []</span>

    <span class="c1">#     for file_name in toadd:</span>
    <span class="c1">#         stem = local_file_by_names[file_name].stem</span>
    <span class="c1">#         suffix = &#39;&#39;.join(suffixes) if (</span>
    <span class="c1">#             suffixes := local_file_by_names[file_name].suffixes) else None</span>

    <span class="c1">#         new_file = await File.api_post(</span>
    <span class="c1">#             session=session, c=c, authorized_user_id=self.user_id, admin=False, create_model=FileAdminCreate(stem=stem, suffix=suffix, gallery_id=self.id, size=local_file_by_names[file_name].stat().st_size))</span>

    <span class="c1">#         # rename the file, just to make sure the suffix is lowercase</span>
    <span class="c1">#         local_file_by_names[file_name].rename(</span>
    <span class="c1">#             local_file_by_names[file_name].with_name(new_file.name))</span>

    <span class="c1">#         if suffix in ImageFileMetadataConfig._SUFFIXES:</span>
    <span class="c1">#             image_files.append(new_file)</span>

    <span class="c1">#     # loop through files twice, adding the original images first</span>
    <span class="c1">#     for original_images in [True, False]:</span>
    <span class="c1">#         for image_file in image_files:</span>

    <span class="c1">#             base_name, version, scale = ImageFileMetadata.parse_file_stem(</span>
    <span class="c1">#                 image_file.stem)</span>

    <span class="c1">#             if original_images == (version == None):</span>

    <span class="c1">#                 parent_id = None</span>
    <span class="c1">#                 if version is not None:</span>
    <span class="c1">#                     image_version_og = session.exec(select(ImageVersion).where(ImageVersion.gallery_id == self._id).where(</span>
    <span class="c1">#                         ImageVersion.base_name == base_name).where(ImageVersion.version == None)).one_or_none()</span>

    <span class="c1">#                     # if an original exists, assume the version wants to link as the parent</span>
    <span class="c1">#                     if image_version_og:</span>
    <span class="c1">#                         parent_id = image_version_og._id</span>

    <span class="c1">#                 image_version_kwargs = {</span>
    <span class="c1">#                     &#39;gallery_id&#39;: self.id,</span>
    <span class="c1">#                     &#39;base_name&#39;: base_name if parent_id is None else None,</span>
    <span class="c1">#                     &#39;version&#39;: version,</span>
    <span class="c1">#                     &#39;parent_id&#39;: parent_id</span>
    <span class="c1">#                 }</span>

    <span class="c1">#                 image_version = session.exec(select(ImageVersion).where(</span>
    <span class="c1">#                     ImageVersion._build_conditions(image_version_kwargs))).one_or_none()</span>

    <span class="c1">#                 # this if the first file of this version</span>
    <span class="c1">#                 if not image_version:</span>
    <span class="c1">#                     image_version = await ImageVersion.api_post(session=session, c=c, authorized_user_id=self.user_id, admin=False, create_model=ImageVersionAdminCreate(**image_version_kwargs))</span>

    <span class="c1">#                 image_file_metadata = await ImageFileMetadata.api_post(session=session, c=c, authorized_user_id=self.user_id, admin=False, create_model=ImageFileMetadataAdminCreate(file_id=image_file.id, version_id=image_version.id, scale=scale))</span>

    <span class="c1">#     # recursively sync children</span>
    <span class="c1">#     for child in self.children:</span>
    <span class="c1">#         await child.sync_with_local(session, c, dir / child.folder_name)</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        def sync_with_local(self):</span>
<span class="sd">        &quot;&quot;&quot;sync database with local directory contents&quot;&quot;&quot;</span>

<span class="sd">        if input(&#39;Are you sure you want to sync with local? (y/n) &#39;) != &#39;y&#39;:</span>
<span class="sd">            return</span>

<span class="sd">        # Studios</span>
<span class="sd">        studio_id_keys_to_add, studio_ids_to_delete = studio.Studio.find_to_add_and_delete(</span>
<span class="sd">            self.db[studio.Studio.COLLECTION_NAME], self.studios_dir)</span>

<span class="sd">        print(&#39;Studios to add&#39;)</span>
<span class="sd">        print(studio_id_keys_to_add)</span>
<span class="sd">        print(&#39;Studios to delete&#39;)</span>
<span class="sd">        print(studio_ids_to_delete)</span>
<span class="sd">        print()</span>

<span class="sd">        for studio_id_keys in studio_id_keys_to_add:</span>
<span class="sd">            new_studio = studio.Studio.make_from_id_keys(studio_id_keys)</span>
<span class="sd">            new_studio.insert(self.db[studio.Studio.COLLECTION_NAME])</span>

<span class="sd">        studio.Studio.delete_by_ids(</span>
<span class="sd">            self.db[studio.Studio.COLLECTION_NAME], list(studio_ids_to_delete))</span>

<span class="sd">        # Events</span>
<span class="sd">        # remove events that reference studios that no longer exist</span>
<span class="sd">        studio_id_keys_by_id = studio.Studio.find_id_keys_by_id(</span>
<span class="sd">            self.db[studio.Studio.COLLECTION_NAME])</span>

<span class="sd">        stale_event_ids = event.Event.find_ids(</span>
<span class="sd">            self.db[event.Event.COLLECTION_NAME], filter={&#39;studio_id&#39;: {&#39;$nin&#39;: list(studio_id_keys_by_id.keys())}})</span>

<span class="sd">        print(&#39;Stale event ids&#39;)</span>
<span class="sd">        print(stale_event_ids)</span>
<span class="sd">        print()</span>

<span class="sd">        event.Event.delete_by_ids(</span>
<span class="sd">            self.db[event.Event.COLLECTION_NAME], list(stale_event_ids))</span>

<span class="sd">        # loop through existing studios and update events</span>
<span class="sd">        for studio_id in studio_id_keys_by_id:</span>
<span class="sd">            studio_dir_name = studio_id_keys_by_id[studio_id][0]</span>
<span class="sd">            studio_dir = self.studios_dir.joinpath(studio_dir_name)</span>

<span class="sd">            event_id_keys_to_add, event_ids_to_delete = event.Event.find_to_add_and_delete(</span>
<span class="sd">                self.db[event.Event.COLLECTION_NAME], studio_dir, studio_id)</span>

<span class="sd">            print(studio_id)</span>
<span class="sd">            print(event_id_keys_to_add)</span>
<span class="sd">            print(event_ids_to_delete)</span>
<span class="sd">            print()</span>

<span class="sd">            for event_id_keys in event_id_keys_to_add:</span>
<span class="sd">                new_event = event.Event.make_from_id_keys(event_id_keys)</span>
<span class="sd">                new_event.insert(self.db[event.Event.COLLECTION_NAME])</span>

<span class="sd">            event.Event.delete_by_ids(</span>
<span class="sd">                self.db[event.Event.COLLECTION_NAME], list(event_ids_to_delete))</span>

<span class="sd">        # groups</span>
<span class="sd">        # remove groups that reference events that no longer exist</span>
<span class="sd">        event_id_keys_by_id = event.Event.find_id_keys_by_id(</span>
<span class="sd">            self.db[event.Event.COLLECTION_NAME])</span>

<span class="sd">        stale_file_ids = media.Media.find_ids(</span>
<span class="sd">            self.db[media.Media.COLLECTION_NAME], filter={&#39;event_id&#39;: {&#39;$nin&#39;: list(event_id_keys_by_id.keys())}})</span>

<span class="sd">        print(&#39;Stale file ids&#39;)</span>
<span class="sd">        print(stale_file_ids)</span>
<span class="sd">        print()</span>

<span class="sd">        media.Media.delete_by_ids(</span>
<span class="sd">            self.db[media.Media.COLLECTION_NAME], list(stale_file_ids))</span>

<span class="sd">        # loop through existing events and update groups</span>
<span class="sd">        for event_id in event_id_keys_by_id:</span>
<span class="sd">            event_dict = event.Event.id_keys_to_dict(</span>
<span class="sd">                event_id_keys_by_id[event_id])</span>

<span class="sd">            event_dir = self.studios_dir.joinpath(studio_id_keys_by_id[event_dict[&#39;studio_id&#39;]][0]).joinpath(</span>
<span class="sd">                event.Event.build_directory_name(</span>
<span class="sd">                    {&#39;datetime&#39;: event_dict[&#39;datetime&#39;], &#39;name&#39;: event_dict[&#39;name&#39;]})</span>
<span class="sd">            )</span>

<span class="sd">            file_id_keys_to_add, file_ids_to_delete = media.Media.find_to_add_and_delete(</span>
<span class="sd">                self.db[media.Media.COLLECTION_NAME], event_dir, event_id)</span>

<span class="sd">            print(event_id)</span>
<span class="sd">            print(file_id_keys_to_add)</span>
<span class="sd">            print(file_ids_to_delete)</span>

<span class="sd">            for file_id_keys in file_id_keys_to_add:</span>
<span class="sd">                file_class = media.Media.get_media_type_from_id_keys(</span>
<span class="sd">                    file_id_keys)</span>
<span class="sd">                if file_class is None:</span>
<span class="sd">                    Warning(&#39;File ending not recognized {} not recognized on file {}&#39;.format(</span>
<span class="sd">                        file_id_keys[&#39;file_ending&#39;], file_id_keys))</span>
<span class="sd">                    continue</span>
<span class="sd">                new_file = file_class.make_from_id_keys(file_id_keys)</span>
<span class="sd">                new_file.insert(self.db[media.Media.COLLECTION_NAME])</span>

<span class="sd">            media.Media.delete_by_ids(</span>
<span class="sd">                self.db[media.Media.COLLECTION_NAME], list(file_ids_to_delete))</span>
<span class="sd">        &#39;&#39;&#39;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>